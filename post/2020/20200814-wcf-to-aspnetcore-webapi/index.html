<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>*æ—§ WCF é¡¹ç›®æˆåŠŸè¿ç§»åˆ° asp.net core web api - é£é›ªå¤œå½’äºº</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Long" />
  <meta name="description" content="èƒŒæ™¯ æ¥ä¸Šä¸€ç¯‡ï¼Œæ”¾å¼ƒäº† asp.net core &#43; gRPC çš„æ–¹æ¡ˆåï¼Œæˆ‘çµå…‰ä¸€é—ªï¼Œä¸ºä»€ä¹ˆä¸ç”¨ web api å‘¢ï¼Ÿä¸ä¹Ÿæ˜¯ asp.net core çš„å—ï¼Ÿè™½ç„¶ RESTful ä¸æ˜¯å¼ºçº¦æŸï¼Œå®¢æˆ·ç«¯å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œé¿å…å¤§å¹…ä¿®æ”¹æ—§æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚
åœ¨ç½‘ä¸Šæ‰¾åˆ°ç›¸å½“å¤šçš„æ–‡ç« ï¼Œæ¯”è¾ƒ gRPC å’Œ RESTful çš„ä¼˜ç¼ºç‚¹ï¼Œç»“è®ºéƒ½æ˜¯ gRPC æ¨èç”¨ä½œå†…éƒ¨ç³»ç»Ÿé—´è°ƒç”¨ï¼Œ RESTful æ¨èç”¨ä½œå¯¹å¤–å¼€æ”¾æ¥å£ã€‚
é€‰æ‹© RESTful å¦ä¸€ä¸ªæœ€é‡è¦çš„åŸå› æ˜¯ï¼ŒgRPC çš„åº•å±‚æ¡†æ¶éœ€è¦HTTP2ï¼Œè€Œ win7 ä¸æ”¯æŒHTTP2ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†ç”¨æˆ·åœ¨ win7 ä¸Šã€‚ä¸Šç¯‡æœ‰äººæ¨è grpc web ï¼Œç”±äºé¡¹ç›®æ˜¯ WPF æ¡Œé¢å®¢æˆ·ç«¯ï¼Œè¿™ç§ web æ–¹å¼å¯èƒ½å°±æ›´ä¸é€‚åˆäº†ã€‚
" />

  <meta name="keywords" content="ç å†œ, é€»è¾‘, è‡ªç”±" />



<meta name="google-site-verification" content="hqw-Lg4woniVGx2b2LZ25xQDQsh_da1VWm_nhza2aZg" />


<meta name="generator" content="Hugo 0.74.3" />


<link rel="canonical" href="https://mrbenwang.github.io/post/2020/20200814-wcf-to-aspnetcore-webapi/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="*æ—§ WCF é¡¹ç›®æˆåŠŸè¿ç§»åˆ° asp.net core web api" />
<meta property="og:description" content="èƒŒæ™¯
æ¥ä¸Šä¸€ç¯‡ï¼Œæ”¾å¼ƒäº† asp.net core &#43; gRPC çš„æ–¹æ¡ˆåï¼Œæˆ‘çµå…‰ä¸€é—ªï¼Œä¸ºä»€ä¹ˆä¸ç”¨ web api å‘¢ï¼Ÿä¸ä¹Ÿæ˜¯ asp.net core çš„å—ï¼Ÿè™½ç„¶ RESTful ä¸æ˜¯å¼ºçº¦æŸï¼Œå®¢æˆ·ç«¯å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œé¿å…å¤§å¹…ä¿®æ”¹æ—§æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚
åœ¨ç½‘ä¸Šæ‰¾åˆ°ç›¸å½“å¤šçš„æ–‡ç« ï¼Œæ¯”è¾ƒ gRPC å’Œ RESTful çš„ä¼˜ç¼ºç‚¹ï¼Œç»“è®ºéƒ½æ˜¯ gRPC æ¨èç”¨ä½œå†…éƒ¨ç³»ç»Ÿé—´è°ƒç”¨ï¼Œ RESTful æ¨èç”¨ä½œå¯¹å¤–å¼€æ”¾æ¥å£ã€‚
é€‰æ‹© RESTful å¦ä¸€ä¸ªæœ€é‡è¦çš„åŸå› æ˜¯ï¼ŒgRPC çš„åº•å±‚æ¡†æ¶éœ€è¦HTTP2ï¼Œè€Œ win7 ä¸æ”¯æŒHTTP2ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†ç”¨æˆ·åœ¨ win7 ä¸Šã€‚ä¸Šç¯‡æœ‰äººæ¨è grpc web ï¼Œç”±äºé¡¹ç›®æ˜¯ WPF æ¡Œé¢å®¢æˆ·ç«¯ï¼Œè¿™ç§ web æ–¹å¼å¯èƒ½å°±æ›´ä¸é€‚åˆäº†ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mrbenwang.github.io/post/2020/20200814-wcf-to-aspnetcore-webapi/" />
<meta property="article:published_time" content="2020-08-14T11:11:00+08:00" />
<meta property="article:modified_time" content="2020-08-14T23:46:00+08:00" />
<meta itemprop="name" content="*æ—§ WCF é¡¹ç›®æˆåŠŸè¿ç§»åˆ° asp.net core web api">
<meta itemprop="description" content="èƒŒæ™¯
æ¥ä¸Šä¸€ç¯‡ï¼Œæ”¾å¼ƒäº† asp.net core &#43; gRPC çš„æ–¹æ¡ˆåï¼Œæˆ‘çµå…‰ä¸€é—ªï¼Œä¸ºä»€ä¹ˆä¸ç”¨ web api å‘¢ï¼Ÿä¸ä¹Ÿæ˜¯ asp.net core çš„å—ï¼Ÿè™½ç„¶ RESTful ä¸æ˜¯å¼ºçº¦æŸï¼Œå®¢æˆ·ç«¯å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œé¿å…å¤§å¹…ä¿®æ”¹æ—§æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚
åœ¨ç½‘ä¸Šæ‰¾åˆ°ç›¸å½“å¤šçš„æ–‡ç« ï¼Œæ¯”è¾ƒ gRPC å’Œ RESTful çš„ä¼˜ç¼ºç‚¹ï¼Œç»“è®ºéƒ½æ˜¯ gRPC æ¨èç”¨ä½œå†…éƒ¨ç³»ç»Ÿé—´è°ƒç”¨ï¼Œ RESTful æ¨èç”¨ä½œå¯¹å¤–å¼€æ”¾æ¥å£ã€‚
é€‰æ‹© RESTful å¦ä¸€ä¸ªæœ€é‡è¦çš„åŸå› æ˜¯ï¼ŒgRPC çš„åº•å±‚æ¡†æ¶éœ€è¦HTTP2ï¼Œè€Œ win7 ä¸æ”¯æŒHTTP2ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†ç”¨æˆ·åœ¨ win7 ä¸Šã€‚ä¸Šç¯‡æœ‰äººæ¨è grpc web ï¼Œç”±äºé¡¹ç›®æ˜¯ WPF æ¡Œé¢å®¢æˆ·ç«¯ï¼Œè¿™ç§ web æ–¹å¼å¯èƒ½å°±æ›´ä¸é€‚åˆäº†ã€‚">
<meta itemprop="datePublished" content="2020-08-14T11:11:00+08:00" />
<meta itemprop="dateModified" content="2020-08-14T23:46:00+08:00" />
<meta itemprop="wordCount" content="5488">



<meta itemprop="keywords" content="net core,web api," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="*æ—§ WCF é¡¹ç›®æˆåŠŸè¿ç§»åˆ° asp.net core web api"/>
<meta name="twitter:description" content="èƒŒæ™¯
æ¥ä¸Šä¸€ç¯‡ï¼Œæ”¾å¼ƒäº† asp.net core &#43; gRPC çš„æ–¹æ¡ˆåï¼Œæˆ‘çµå…‰ä¸€é—ªï¼Œä¸ºä»€ä¹ˆä¸ç”¨ web api å‘¢ï¼Ÿä¸ä¹Ÿæ˜¯ asp.net core çš„å—ï¼Ÿè™½ç„¶ RESTful ä¸æ˜¯å¼ºçº¦æŸï¼Œå®¢æˆ·ç«¯å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œé¿å…å¤§å¹…ä¿®æ”¹æ—§æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç ã€‚
åœ¨ç½‘ä¸Šæ‰¾åˆ°ç›¸å½“å¤šçš„æ–‡ç« ï¼Œæ¯”è¾ƒ gRPC å’Œ RESTful çš„ä¼˜ç¼ºç‚¹ï¼Œç»“è®ºéƒ½æ˜¯ gRPC æ¨èç”¨ä½œå†…éƒ¨ç³»ç»Ÿé—´è°ƒç”¨ï¼Œ RESTful æ¨èç”¨ä½œå¯¹å¤–å¼€æ”¾æ¥å£ã€‚
é€‰æ‹© RESTful å¦ä¸€ä¸ªæœ€é‡è¦çš„åŸå› æ˜¯ï¼ŒgRPC çš„åº•å±‚æ¡†æ¶éœ€è¦HTTP2ï¼Œè€Œ win7 ä¸æ”¯æŒHTTP2ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†ç”¨æˆ·åœ¨ win7 ä¸Šã€‚ä¸Šç¯‡æœ‰äººæ¨è grpc web ï¼Œç”±äºé¡¹ç›®æ˜¯ WPF æ¡Œé¢å®¢æˆ·ç«¯ï¼Œè¿™ç§ web æ–¹å¼å¯èƒ½å°±æ›´ä¸é€‚åˆäº†ã€‚"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-130619472-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">é£é›ªå¤œå½’äºº</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/">ä¸»é¡µ</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/post/">å…¨éƒ¨æ–‡ç« </a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/tags/">æ ‡ç­¾</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/categories/">åˆ†ç±»</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/about/">å…³äº</a>
          
        
      </li>
    

    
      <li class="mobile-menu-item">
        <a id="openSearchMobile" class="mobile-menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  
    
<div class="modal-dialog">
    
    <div class="modal-content">
      <div id="closeSearch" title="Close" class="close">X</div>
      <div class="modal-header">
        <div class="modal-title">Search</div>
      </div>
      <div class="modal-body">
          <script>
            (function() {
              var cx = '015982908853339398897:duxagwzp5jn';
              var gcse = document.createElement('script');
              gcse.type = 'text/javascript';
              gcse.async = true;
              gcse.src = (document.location.protocol == 'https:' ? 'https:' :
                  'http:') +
                '//cse.google.com/cse.js?cx=' + cx;
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          <gcse:search></gcse:search>
      </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      é£é›ªå¤œå½’äºº
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/">ä¸»é¡µ</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/post/">å…¨éƒ¨æ–‡ç« </a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/tags/">æ ‡ç­¾</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/categories/">åˆ†ç±»</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://mrbenwang.github.io/about/">å…³äº</a>
          

        

      </li>
    

    
    

    
      <li class="menu-item">
        <a id="openSearch" class="menu-item-link menu-item-search" href="#">
          <i class="iconfont">
            <svg version="1.1" viewBox="0 0 1024 1024"
  xmlns="http://www.w3.org/2000/svg" width="18" height="18"
  xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M973.81454219 973.81454219a91.78207815 91.78207815 0 0 1-129.80999631 0l-161.97482118-161.97482118a425.48527711 425.48527711 0 0 1-230.35931791 68.16531768 428.3346319 428.3346319 0 1 1 428.3346319-428.3346319 425.48527711 425.48527711 0 0 1-68.16531768 230.35931791l162.02961656 161.97482118a91.83687354 91.83687354 0 0 1-0.05479538 129.80999631zM451.67040679 145.69361559a305.97679241 305.97679241 0 1 0 0 611.95358361 305.97679241 305.97679241 0 0 0 0-611.95358361z">
  </path>
</svg>

          </i>
        </a>
      </li>
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">*æ—§ WCF é¡¹ç›®æˆåŠŸè¿ç§»åˆ° asp.net core web api</h1>
      
      <div class="post-meta">
        <time datetime="2020-08-14" class="post-time">
          2020-08-14 11:11
        </time>
        <div class="post-category">
            <a href="https://mrbenwang.github.io/categories/%E5%B7%A5%E4%BD%9C%E9%9A%8F%E7%AC%94/"> å·¥ä½œéšç¬” </a>
            
          </div>
        <span class="more-meta"> çº¦ 5488 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 11 åˆ†é’Ÿ </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#èƒŒæ™¯">èƒŒæ™¯</a></li>
    <li><a href="#entity-framework-core">Entity Framework Core</a>
      <ul>
        <li><a href="#åŸºç¡€å®‰è£…å’Œé…ç½®">åŸºç¡€å®‰è£…å’Œé…ç½®</a></li>
        <li><a href="#ef6-to-ef-core-31">EF6 to EF Core 3.1</a></li>
        <li><a href="#å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</a></li>
      </ul>
    </li>
    <li><a href="#æœåŠ¡ç«¯-aspnet-core-web-api">æœåŠ¡ç«¯ asp.net core web api</a>
      <ul>
        <li><a href="#å¯åŠ¨ç±»-startup">å¯åŠ¨ç±» StartUp</a></li>
        <li><a href="#è·¯ç”±-å’Œ-controller">è·¯ç”± å’Œ Controller</a></li>
        <li><a href="#nswag">Nswag</a></li>
        <li><a href="#ä¸Šä¼ æ–‡ä»¶">ä¸Šä¼ æ–‡ä»¶</a></li>
        <li><a href="#å…¨å±€å¼‚å¸¸æ•è·">å…¨å±€å¼‚å¸¸æ•è·</a></li>
      </ul>
    </li>
    <li><a href="#å®¢æˆ·ç«¯-webapiclient">å®¢æˆ·ç«¯ WebApiClient</a>
      <ul>
        <li><a href="#webapiclienttool">WebApiClient.Tool</a></li>
        <li><a href="#webapiclientjit">WebApiClient.JIT</a></li>
      </ul>
    </li>
    <li><a href="#éƒ¨ç½²-ubuntu--nginx">éƒ¨ç½² Ubuntu + Nginx</a>
      <ul>
        <li><a href="#è‡ªåŠ¨åŒ–è„šæœ¬">è‡ªåŠ¨åŒ–è„šæœ¬</a></li>
      </ul>
    </li>
    <li><a href="#å…¶ä»–çš„æ”¹åŠ¨">å…¶ä»–çš„æ”¹åŠ¨</a>
      <ul>
        <li><a href="#log4net">log4net</a></li>
        <li><a href="#framework-40-çš„-md5-æ–¹æ³•åºŸå¼ƒ">Framework 4.0 çš„ md5 æ–¹æ³•åºŸå¼ƒ</a></li>
        <li><a href="#datetimeoffset-å’Œ-datetime">DateTimeOffset å’Œ DateTime</a></li>
      </ul>
    </li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æ¥ä¸Šä¸€ç¯‡ï¼Œæ”¾å¼ƒäº† asp.net core + gRPC çš„æ–¹æ¡ˆåï¼Œæˆ‘çµå…‰ä¸€é—ªï¼Œä¸ºä»€ä¹ˆä¸ç”¨ web api å‘¢ï¼Ÿä¸ä¹Ÿæ˜¯ asp.net core çš„å—ï¼Ÿè™½ç„¶ RESTful ä¸æ˜¯å¼ºçº¦æŸï¼Œå®¢æˆ·ç«¯å†™èµ·æ¥ä¹Ÿéº»çƒ¦ï¼Œä½†è¿˜æ˜¯å¯ä»¥æ»¡è¶³åŸºæœ¬éœ€æ±‚ï¼Œ<strong>é¿å…å¤§å¹…ä¿®æ”¹</strong><code>æ—§æœ‰çš„ä¸šåŠ¡é€»è¾‘ä»£ç </code>ã€‚</p>
<p>åœ¨ç½‘ä¸Šæ‰¾åˆ°ç›¸å½“å¤šçš„æ–‡ç« ï¼Œæ¯”è¾ƒ gRPC å’Œ RESTful çš„ä¼˜ç¼ºç‚¹ï¼Œç»“è®ºéƒ½æ˜¯ <code>gRPC</code> æ¨èç”¨ä½œ<strong>å†…éƒ¨ç³»ç»Ÿé—´è°ƒç”¨</strong>ï¼Œ <code>RESTful</code> æ¨èç”¨ä½œ<strong>å¯¹å¤–å¼€æ”¾æ¥å£</strong>ã€‚<br>
é€‰æ‹© <code>RESTful</code> å¦ä¸€ä¸ªæœ€é‡è¦çš„åŸå› æ˜¯ï¼Œ<code>gRPC</code> çš„åº•å±‚æ¡†æ¶éœ€è¦HTTP2ï¼Œè€Œ win7 ä¸æ”¯æŒHTTP2ï¼Œæœ‰ç›¸å½“ä¸€éƒ¨åˆ†ç”¨æˆ·åœ¨ win7 ä¸Šã€‚ä¸Šç¯‡æœ‰äººæ¨è <code>grpc web</code> ï¼Œç”±äºé¡¹ç›®æ˜¯ <strong>WPF æ¡Œé¢å®¢æˆ·ç«¯</strong>ï¼Œè¿™ç§ web æ–¹å¼å¯èƒ½å°±æ›´ä¸é€‚åˆäº†ã€‚</p>
<h2 id="entity-framework-core">Entity Framework Core</h2>
<h3 id="åŸºç¡€å®‰è£…å’Œé…ç½®">åŸºç¡€å®‰è£…å’Œé…ç½®</h3>
<blockquote>
<p>è¿™éƒ¨åˆ†åŸºæœ¬ä¸ä¸Šä¸€ç¯‡çš„å‰åŠéƒ¨åˆ†å†…å®¹ä¸€è‡´ï¼Œä¸ºäº†ä¿è¯å•ç¯‡æ–‡ç« çš„ç‹¬ç«‹æ€§ã€‚æŠŠè¿™éƒ¨åˆ†å†…å®¹å®Œå…¨ copy è¿‡æ¥ğŸ™„ğŸ™„ğŸ™„ã€‚</p>
</blockquote>
<p>æ—§çš„WCFé¡¹ç›®ï¼Œæ•°æ®åº“è®¿é—®ä½¿ç”¨çš„æ˜¯ Entity Framework + Linq + MySqlã€‚éœ€è¦å®‰è£…çš„ Nuget åŒ…ï¼š</p>
<ul>
<li><code>MySql.Data.EntityFrameworkCore</code> Mysqlçš„EFæ ¸å¿ƒåº“ï¼›</li>
<li><code>Microsoft.EntityFrameworkCore.Proxies</code> <a href="https://docs.microsoft.com/en-us/ef/core/querying/related-data#lazy-loading">ã€ŠLazy loading ã€‹</a> æ‡’åŠ è½½çš„æ’ä»¶ï¼›</li>
<li><code>Microsoft.EntityFrameworkCore.Design</code> å’Œ <code>Microsoft.EntityFrameworkCore.Tools</code> è¿™ä¸¤ä¸ªæ’ä»¶ï¼Œç”¨äºç”Ÿæˆä»£ç ï¼›</li>
</ul>
<p>å¦å¤–ï¼Œè¿˜éœ€è¦ä¸‹è½½å®‰è£… <a href="https://dev.mysql.com/downloads/connector/net/">mysql-connector-net-8.0.21.msi</a> æ¥è®¿é—®æ•°æ®åº“ã€‚å…¶ä¸­æœ‰ä¸€ä¸ª <code>Scaffold-DbContext</code> çš„<a href="https://bugs.mysql.com/bug.php?id=99419">bug 99419</a> TINYINT(1) è½¬åŒ–ä¸º byteï¼Œè€Œä¸æ˜¯é¢„æœŸçš„ boolã€‚è¿™ä¸ªé—®é¢˜å°†ä¼šåœ¨ 8.0.22 ç‰ˆæœ¬ä¸­ä¿®å¤ï¼Œç›®å‰åªèƒ½æ‰‹åŠ¨ä¿®æ”¹ã€‚<br>
EFå½“ç„¶æ˜¯ <code>Database First</code> äº†ï¼Œç”ŸæˆEFä»£ç éœ€è¦åœ¨<code>Package Manager Console</code>ç”¨åˆ° <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/powershell#scaffold-dbcontext">Scaffold-DbContext</a> å‘½ä»¤ï¼Œæœ‰ä¸‰ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li><code>Start up</code> å¯å§‹é¡¹ç›®ä¸€å®šè¦æ˜¯å¼•ç”¨å®ƒçš„é¡¹ç›®ï¼Œå¹¶ä¸”ç¼–è¯‘æˆåŠŸçš„ï¼›</li>
<li><code>Default project</code> ç”Ÿæˆåï¼Œä»£ç å­˜æ”¾çš„é¡¹ç›®ï¼›</li>
<li>å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæç¤ºï¼šâ€œYour startup project &lsquo;XXXX&rsquo; doesn&rsquo;t reference Microsoft.EntityFrameworkCore.Design. This package is required for the Entity Framework Core Tools to work. Ensure your startup project is correct, install the package, and try again.â€ã€‚ç¼–è¾‘é¡¹ç›®æ–‡ä»¶ csproj ç§»é™¤ <code>&lt;PrivateAssets&gt;All&lt;/PrivateAssets&gt;</code> ä» &ldquo;Microsoft.EntityFrameworkCore.Design&quot;å’Œ&quot;Microsoft.EntityFrameworkCore.Tools&quot;ä¸­ï¼›</li>
</ul>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/01-ef-general-code-edit-csproj.jpg" alt="EF remove PrivateAssets"></p>
<p>æˆ‘çš„å‘½ä»¤ï¼š <code>Scaffold-DbContext -Connection &quot;server=10.50.40.50;port=3306;user=myuser;password=123456;database=dbname&quot; -Provider MySql.Data.EntityFrameworkCore -OutputDir &quot;EFModel&quot; -ContextDir &quot;Context&quot; -Project &quot;DataAccess&quot; -Context &quot;BaseEntities&quot; -UseDatabaseNames -Force</code></p>
<p>å…¶ä»–å»ºè®®ï¼š</p>
<ul>
<li>Libraryç±»åº“æœ€å¥½æ˜¯ <code>Net Standard</code> æ–¹ä¾¿ç§»æ¤ï¼›</li>
<li>æ–°å»ºä¸€ä¸ªç±»æ¥ç»§æ‰¿<code>BaseEntities</code>ï¼Œè¦†ç›– <code>OnConfiguring</code> æ–¹æ³•ï¼Œå¯é…ç½®çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Entities</span> <span class="p">:</span> <span class="n">BaseEntities</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">_lstDBString</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">SetDefaultDBString</span><span class="p">(</span><span class="kt">string</span> <span class="n">_dbString</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">_lstDBString</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">_lstDBString</span> <span class="p">=</span> <span class="n">_dbString</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="n">OnConfiguring</span><span class="p">(</span><span class="n">DbContextOptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">optionsBuilder</span><span class="p">.</span><span class="n">IsConfigured</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">optionsBuilder</span><span class="p">.</span><span class="n">UseLazyLoadingProxies</span><span class="p">().</span><span class="n">UseMySQL</span><span class="p">(</span><span class="n">_lstDBString</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æœ€å¥½é‡‡ç”¨ asp.net core çš„æ¡†æ¶æ³¨å…¥ï¼›é‰´äºé¡¹ç›®çš„åŸå› ï¼Œå‡å¦‚å¼ºè¡Œé‡‡ç”¨çš„è¯ï¼Œæ”¹åŠ¨æ¯”è¾ƒå¤§ï¼Œåªå¥½æ”¾å¼ƒï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">_dbString</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">.</span><span class="n">GetConnectionString</span><span class="p">(</span><span class="s">&#34;MyDatabase&#34;</span><span class="p">);</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddDbContext</span><span class="p">&lt;</span><span class="n">DataAccess</span><span class="p">.</span><span class="n">Context</span><span class="p">.</span><span class="n">Entities</span><span class="p">&gt;(</span>
        <span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="n">UseLazyLoadingProxies</span><span class="p">().</span><span class="n">UseMySQL</span><span class="p">(</span><span class="n">_dbString</span><span class="p">));</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddGrpc</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æ•°æ®åº“é“¾æ¥å­—ç¬¦ä¸²æœ‰å¤šç§å­˜æ”¾çš„æ–¹å¼ï¼Œæœ‰æ›´åŠ å®‰å…¨çš„æ–¹å¼<a href="https://docs.microsoft.com/zh-cn/aspnet/core/security/app-secrets?view=aspnetcore-3.1&amp;tabs=windows#environment-variables">ã€ŠASP.NET Core ä¸­çš„å¼€å‘ä¸­å®‰å…¨å­˜å‚¨åº”ç”¨æœºå¯†ã€‹</a>ï¼›è€Œæˆ‘é‡‡ç”¨ç®€å•æ–¹å¼ï¼Œå­˜æ”¾åœ¨ <code>appsettings.json</code>ï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;ConnectionStrings&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;MyDatabase&#34;</span><span class="p">:</span> <span class="s2">&#34;server=127.0.0.1;port=3306;user=myuser;password=123456;database=dbname&#34;</span>
    <span class="p">},</span>
    <span class="nt">&#34;log4net&#34;</span><span class="p">:</span> <span class="s2">&#34;log4net.config&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Logging&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;LogLevel&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;Default&#34;</span><span class="p">:</span> <span class="s2">&#34;Information&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Microsoft&#34;</span><span class="p">:</span> <span class="s2">&#34;Warning&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Microsoft.Hosting.Lifetime&#34;</span><span class="p">:</span> <span class="s2">&#34;Information&#34;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&#34;AllowedHosts&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="ef6-to-ef-core-31">EF6 to EF Core 3.1</h3>
<p>ä» Entity Framework 6 è¿ç§»åˆ° Entity Framework Core 3.1 çš„è°ƒæ•´ï¼š</p>
<ol>
<li>
<p>æç¤ºé”™è¯¯ï¼š<code>â€œSet operations over different store types are currently unsupportedâ€</code>ã€‚Union çš„ä½¿ç”¨æ”¹å˜ï¼Œéœ€è¦æ·»åŠ  <code>AsEnumerable()</code>ï¼Œåœ¨ EF5.0 ä¼šä¿®å¤è¿™ä¸ªé—®é¢˜ <a href="https://github.com/dotnet/efcore/issues/18091#issuecomment-536069419">issues</a>ï¼›<code>AsEnumerable()</code> æ“ä½œçš„æ˜¯ å°† <strong>Linq to Sql</strong> åˆ‡æ¢ä¸º <strong>Linq to Objects</strong> å¯ä»¥æ”¯æŒ L2O çš„æ‰€æœ‰æ“ä½œï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="p">(</span><span class="k">from</span> <span class="n">a</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">km_folder</span>
            <span class="k">select</span> <span class="k">new</span> <span class="n">FolderFileModel</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Id</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">Name</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">folder_name</span>
            <span class="p">}).</span><span class="n">AsEnumerable</span><span class="p">().</span>
            <span class="n">Union</span><span class="p">(</span><span class="k">from</span> <span class="n">a</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">km_fileinfo</span>
                <span class="k">select</span> <span class="k">new</span> <span class="n">FolderFileModel</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">Id</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">Name</span> <span class="p">=</span> <span class="n">a</span><span class="p">.</span><span class="n">file_name</span>
                <span class="p">}).</span><span class="n">AsEnumerable</span><span class="p">();</span>

<span class="c1">// Linq to Sql åˆ‡æ¢ä¸º Linq to Objects ï¼Œ å¯ä»¥æ‰§è¡Œ å¤–éƒ¨æ–¹æ³•
</span><span class="c1"></span><span class="kt">var</span> <span class="n">query2</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Observations</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">o</span> <span class="p">=&gt;</span> <span class="n">o</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="n">AsEnumerable</span><span class="p">().</span><span class="n">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">MySuperSmartMethod</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ç›´æ¥æ‰§è¡Œ sql è¯­å¥çš„æ–¹å¼å‘ç”Ÿæ”¹å˜ï¼Œ sqlæŸ¥è¯¢ç»“æœ ä¸ model é‡Œé¢çš„å­—æ®µè¦ä¸€ä¸€å¯¹åº”ï¼Œå¦‚æœä¸éœ€è¦çš„å­—æ®µå¯ä»¥æ·»åŠ  <code>[NotMapped]</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// EF 6
</span><span class="c1"></span><span class="n">context</span><span class="p">.</span><span class="n">Database</span><span class="p">.</span><span class="n">SqlQuery</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;(</span><span class="n">sql</span><span class="p">,</span> <span class="n">techArgs</span><span class="p">);</span>

<span class="c1">// EF core
</span><span class="c1"></span>
<span class="c1">/// &lt;summary&gt;
</span><span class="c1">/// ä¸ºäº†å…¼å®¹æ‰§è¡Œsqlçš„æ–¹æ³•ï¼Œå‚è€ƒå†™æ³•
</span><span class="c1">/// https://stackoverflow.com/a/50452479/6667125
</span><span class="c1">/// &lt;/summary&gt;
</span><span class="c1"></span><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">BaseEntities</span> <span class="p">:</span> <span class="n">DbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">virtual</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;</span> <span class="n">FolderFileModels</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">partial</span> <span class="k">void</span> <span class="n">OnModelCreatingPartial</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">modelBuilder</span><span class="p">.</span><span class="n">Entity</span><span class="p">&lt;</span><span class="n">FolderFileModel</span><span class="p">&gt;().</span><span class="n">HasNoKey</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">FolderFileModel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">long?</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [NotMapped]</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsSelected</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ‰§è¡Œæ–¹æ³•
</span><span class="c1"></span><span class="n">context</span><span class="p">.</span><span class="n">FolderFileModels</span><span class="p">.</span><span class="n">FromSqlRaw</span><span class="p">(</span><span class="s">&#34;SQL SCRIPT&#34;</span><span class="p">,</span> <span class="n">techArgs</span><span class="p">).</span><span class="n">ToList</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h3>
<p>å‡ºç°é—®é¢˜ï¼š<code>æŒ‡å®šçš„æ¶æ„æ— æ•ˆã€‚é”™è¯¯: CLR ç±»å‹åˆ° EDM ç±»å‹çš„æ˜ å°„ä¸æ˜ç¡®ï¼Œå› ä¸ºå¤šä¸ª CLR ç±»å‹ä¸ EDM ç±»å‹â€œuserâ€åŒ¹é…ã€‚</code></p>
<p>DbContext çš„ MetadataWorkSpace ä¸€æ—¦ç”Ÿæˆä¼šç¼“å­˜èµ·æ¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºåŸŸé‡Œé¢ï¼Œä¸€æ—¦ç”¨dbcontextæ“ä½œè¿‡æ•°æ®åº“ï¼Œå®ƒä¼šè‡ªåŠ¨è¯»å–ç±»æ‰€åœ¨ assembly é‡Œé¢çš„æ‰€æœ‰ç±»ï¼Œå¹¶å°è¯•åŒ¹é…æ•°æ®åº“æ¨¡å‹ï¼Œç„¶åå°†åŒ¹é…ç»“æœä¿å­˜èµ·æ¥(ä¿å­˜åˆ°ä¸Šé¢çš„MetaOCSpaceä¸­)ã€‚å½“ä¸‹æ¬¡æ“ä½œæ•°æ®åº“æ—¶ï¼Œè¿”å›æ•°æ®å¯¹åº”ç±»ç±»æ‰€åœ¨å…¶å®ƒassemblyé‡Œé¢çš„ç±»ä¸å½“å‰å·²åŒ¹é…æ•°æ®åº“æ¨¡å‹å‘ç”Ÿå†²çªæ—¶ï¼Œä¾¿ä¼šæŠ¥é”™ã€‚ï¼ˆè¿™æ®µè¯æ˜¯ç½‘ä¸ŠæŠ„çš„ï¼‰</p>
<div class="shortcode-notice note">
  <div class="shortcode-notice-title note">
    
    åœ¨ASP.NET MVC5é«˜çº§ç¼–ç¨‹ï¼ˆç¬¬5ç‰ˆï¼‰ä¸­ç¬¬70é¡µä½œè€…å†™åˆ°
    
  </div>
  <p>
å®ä½“æ¡†æ¶çš„å¦ä¸€ç§ï¼ˆé»˜è®¤çš„ï¼‰ç­–ç•¥æ˜¯å»¶è¿ŸåŠ è½½ç­–ç•¥ã€‚ä½¿ç”¨å»¶è¿Ÿå»ºåœ¨ç­–ç•¥ï¼ŒEFåœ¨LINQæŸ¥è¯¢ä¸­åªåŠ è½½ä¸»è¦å¯¹è±¡ï¼ˆä¸“è¾‘ï¼‰çš„æ•°æ®ï¼Œè€Œä¸å¡«å……Genreå’ŒArtistå±æ€§ã€‚  
var albums=db.Albums;  
å»¶è¿ŸåŠ è½½æ ¹æ®éœ€è¦æ¥åŠ è½½ç›¸å…³æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰å½“Albumçš„Genreæˆ–Artistéœ€è¦å±æ€§æ—¶ï¼ŒEFæ‰ä¼šå…¬å›½å‘æ•°æ®åº“å‘é€ä¸€ä¸ªä¸ªé¢å¤–çš„æŸ¥è¯¢æ¥åŠ è½½è¿™äº›æ•°æ®ã€‚å»¶è¿ŸåŠ è½½ç­–ç•¥ä¼šå¼ºåˆ¶æ¡†æ¶æœªåˆ—è¡¨ä¸­æ¯ä¸€ä¸ªä¸“è¾‘å‘æ•°æ®åº“å‘é€ä¸€ä¸ªé¢å¤–çš„æŸ¥è¯¢ã€‚  
</p>
</div>
<p>æˆ‘çš„ç†è§£æ˜¯ï¼Œæ‡’åŠ è½½é€šè¿‡åå°„æ¥æŸ¥æ‰¾å®ä½“å¯¹è±¡ï¼Œè€Œè¯¥ç¨‹åºé›†ä¸­ï¼Œå­˜åœ¨å¤šä¸ªåŒåçš„ç±»å‹ï¼Œå³ä½¿æ”¹ç±»å‹åœ¨<strong>ä¸åŒå‘½åç©ºé—´</strong>ä¸‹ä¹Ÿä¼šæŠ¥é”™ã€‚åªè¦å°†ç›¸åŒçš„ç±»å‹åç§°ï¼Œæ”¹ä¸ºä¸ä¸€æ ·å³å¯ã€‚</p>
<h2 id="æœåŠ¡ç«¯-aspnet-core-web-api">æœåŠ¡ç«¯ asp.net core web api</h2>
<p>è¿™éƒ¨åˆ†å¯æ˜¯æ°´è¿˜æ˜¯æœ‰ç‚¹æ·±äº†ã€‚ç”±äºæœ€è¿‘å‡ å¹´ä¸»è¦ä»¥ WPF æ¡Œé¢è½¯ä»¶å¼€å‘ä¸ºä¸»ï¼Œå¾ˆå°‘äº†è§£ asp.net core ã€‚è¿™æ¬¡ç®—æ˜¯æ¶è¡¥äº†ä¸€ä¸‹ï¼Œä¸‹é¢æ˜¯ä¸ªäººæ€»ç»“ï¼Œ<strong>ä¸€åˆ‡ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†</strong>ã€‚</p>
<h3 id="å¯åŠ¨ç±»-startup">å¯åŠ¨ç±» StartUp</h3>
<p>å¯åŠ¨ç±» <code>StartUp.cs</code> ï¼Œåœ¨è¿™é‡Œé¢ä¸»è¦æ˜¯<strong>æ³¨å†ŒæœåŠ¡</strong>(Swaggerã€mvcç­‰)ï¼Œ<strong>æ³¨å†Œä¸­é—´ä»¶</strong>(èº«ä»½è®¤è¯ã€å…¨å±€å¼‚å¸¸æ•è·ç­‰)ï¼Œä»¥åŠ<strong>ä¸åŒç¯å¢ƒçš„åˆ‡æ¢</strong>(Developmentã€Production)ã€‚ä¸‹é¢æ˜¯æˆ‘çš„ StartUp ç±»ï¼Œæœ‰å‡ ç‚¹ç»éªŒæ€»ç»“ï¼š</p>
<ul>
<li>åˆå§‹åŒ–è¯»å–å…¨å±€é…ç½®å‚æ•°ï¼Œæ¯”å¦‚ <code>log4net.config</code>ï¼Œ<code>è¿æ¥å­—ç¬¦ä¸²</code>ç­‰ï¼›</li>
<li>web api åªéœ€è¦æ·»åŠ  <code>services.AddControllers();</code>ï¼Œè€Œä¸æ˜¯ AddMvc();</li>
<li>Swagger <strong>åªåœ¨å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨</strong>ï¼Œè€Œ<strong>ç”Ÿäº§ç¯å¢ƒæ— æ•ˆ</strong>ï¼Œ<a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/environments?view=aspnetcore-3.1#startup-class-conventions">ã€Šåœ¨ ASP.NET Core ä¸­ä½¿ç”¨å¤šä¸ªç¯å¢ƒã€‹</a> å¤šç¯å¢ƒå¼€å‘æµ‹è¯•ï¼ŒçœŸçš„å¤ªå¥½ç”¨äº†ï¼Œ<strong>å¼ºçƒˆæ¨èä½¿ç”¨</strong>ï¼›</li>
<li>åœ¨æ ¹è·¯å¾„ä¸‹å¢åŠ è¿”å›å†…å®¹<code>Hello Asp.Net Core WebApi 3.1!</code>ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•æ˜¯å¦è¿è¡ŒæˆåŠŸã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="n">ConfigureServices</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">InitConfig</span><span class="p">();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddControllers</span><span class="p">();</span>
    <span class="n">services</span><span class="p">.</span><span class="n">AddSwaggerDocument</span><span class="p">(</span><span class="n">SwaggerDocumentConfig</span><span class="p">);</span> <span class="c1">// Register the Swagger services
</span><span class="c1"></span><span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">InitConfig</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Entities</span><span class="p">.</span><span class="n">SetDefaultDBString</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetConnectionString</span><span class="p">(</span><span class="s">&#34;MyDatabase&#34;</span><span class="p">));</span>
    <span class="n">Common</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">InitLog4NetConfig</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&#34;log4net&#34;</span><span class="p">).</span><span class="n">Value</span><span class="p">);</span>
    <span class="n">Common</span><span class="p">.</span><span class="n">WebApiLogger</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;Start WebApi!&#34;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">void</span> <span class="n">SwaggerDocumentConfig</span><span class="p">(</span><span class="n">NSwag</span><span class="p">.</span><span class="n">Generation</span><span class="p">.</span><span class="n">AspNetCore</span><span class="p">.</span><span class="n">AspNetCoreOpenApiDocumentGeneratorSettings</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">config</span><span class="p">.</span><span class="n">PostProcess</span> <span class="p">=</span> <span class="n">document</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Version</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Startup</span><span class="p">).</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetName</span><span class="p">().</span><span class="n">Version</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Title</span> <span class="p">=</span> <span class="s">&#34;Test Web Api&#34;</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Description</span> <span class="p">=</span> <span class="s">&#34;ä»…ä¾›æµ‹è¯•å’Œå‘å¼€ä½¿ç”¨ã€‚&#34;</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="n">Info</span><span class="p">.</span><span class="n">Contact</span> <span class="p">=</span> <span class="k">new</span> <span class="n">NSwag</span><span class="p">.</span><span class="n">OpenApiContact</span>
        <span class="p">{</span>
            <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;long&#34;</span><span class="p">,</span>
            <span class="n">Email</span> <span class="p">=</span> <span class="s">&#34;long@test.com&#34;</span>
        <span class="p">};</span>
    <span class="p">};</span>
<span class="p">}</span>


<span class="k">public</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IApplicationBuilder</span> <span class="n">app</span><span class="p">,</span> <span class="n">IWebHostEnvironment</span> <span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">IsDevelopment</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">app</span><span class="p">.</span><span class="n">UseDeveloperExceptionPage</span><span class="p">();</span>

        <span class="c1">// Register the Swagger generator and the Swagger UI middlewares
</span><span class="c1"></span>        <span class="n">app</span><span class="p">.</span><span class="n">UseOpenApi</span><span class="p">();</span>
        <span class="n">app</span><span class="p">.</span><span class="n">UseSwaggerUi3</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">app</span><span class="p">.</span><span class="n">UseCustomExceptionMiddleware</span><span class="p">();</span> <span class="c1">// å…¨å±€å¼‚å¸¸ä¸­é—´ä»¶
</span><span class="c1"></span>    <span class="n">app</span><span class="p">.</span><span class="n">UseRouting</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseAuthorization</span><span class="p">();</span>
    <span class="n">app</span><span class="p">.</span><span class="n">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">endpoints</span><span class="p">.</span><span class="n">MapGet</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="k">async</span> <span class="n">context</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="s">&#34;Hello Asp.Net Core WebApi 3.1!&#34;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="n">endpoints</span><span class="p">.</span><span class="n">MapControllers</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="è·¯ç”±-å’Œ-controller">è·¯ç”± å’Œ Controller</h3>
<p>çœŸå¿ƒçš„è§‰å¾— asp.net core çš„è·¯ç”±è®¾è®¡ï¼ŒçœŸçš„æ˜¯å¤ªæ£’äº†ï¼è€Œæˆ‘åªç”¨åˆ°äº†å…¶ä¸­<strong>å¾ˆå°çš„ä¸€éƒ¨åˆ†</strong><a href="https://docs.microsoft.com/zh-cn/aspnet/core/mvc/controllers/routing?view=aspnetcore-3.1#attribute-routing-for-rest-apis">ã€ŠREST Api çš„å±æ€§è·¯ç”±ã€‹</a>ã€‚å…¶ä¸­æœ‰ä¸ªæ³¨æ„ç‚¹ï¼Œ<strong>å…¨å±€è·¯ç”±ä¸å±æ€§è·¯ç”±ä¼šæœ‰å†²çª</strong>ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</p>
<p>ä¸ºäº†æ–¹ä¾¿ç®¡ç†è·¯ç”±ï¼Œçµæ´»ä½¿ç”¨ï¼Œä»¥åŠåæœŸç‰ˆæœ¬çš„ç»´æŠ¤ï¼Œåˆ›å»ºä¸€ä¸ª<code>è·¯ç”±æ¨¡æ¿</code>å’Œ <code>ControlleråŸºç±»</code>ï¼Œæ‰€æœ‰ Controller éƒ½ç»§æ‰¿è‡ª <code>MyControllerBase</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">MyV1ApiRouteAttribute</span> <span class="p">:</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">IRouteTemplateProvider</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Template</span> <span class="p">=&gt;</span> <span class="s">&#34;api/v1/[controller]/[action]&#34;</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int?</span> <span class="n">Order</span> <span class="p">=&gt;</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
<span class="na">
</span><span class="na">[ApiController]</span>
<span class="na">[MyV1ApiRoute]</span>
<span class="na">[Produces(MediaTypeNames.Application.Json)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">MyControllerBase</span> <span class="p">:</span> <span class="n">ControllerBase</span>
<span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="nswag">Nswag</h3>
<p><code>Nswag</code> å’Œ <code>Swashbuckle</code> æ˜¯å¾®è½¯å®˜æ–¹æ¨èçš„ Swagger å·¥å…·(<a href="https://petstore.swagger.io/">å®˜æ–¹ swagger åœ¨çº¿è¯•ç”¨</a>ğŸ˜†)ã€‚æˆ‘é€‰æ‹© Nswag çš„ä¸»è¦åŸå› æ˜¯ï¼Œå®ƒæä¾›çš„å·¥å…·ï¼Œ<strong>æ ¹æ® API ç”Ÿæˆ C# å®¢æˆ·ç«¯ä»£ç </strong>ï¼Œå…¶å®åˆ°æœ€åæˆ‘ä¹Ÿæ²¡æœ‰ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚ <a href="https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/getting-started-with-nswag?view=aspnetcore-3.1&amp;tabs=visual-studio">ã€ŠNSwag å’Œ ASP.NET Core å…¥é—¨ã€‹</a>ã€‚</p>
<p>Nswag ä½¿ç”¨èµ·æ¥ä¹Ÿéå¸¸ç®€å•ï¼Œå‚è€ƒæˆ‘çš„ <a href="#%E5%90%AF%E5%8A%A8%E7%B1%BB-startup">å¯åŠ¨ç±» StartUp</a> ä¸­çš„å†™æ³•ã€‚å¦‚æœæƒ³è¦æŠŠä»£ç ä¸­çš„æ³¨é‡Šä¹Ÿä½“ç°åœ¨ Swagger æ–‡æ¡£ä¸­ï¼Œéœ€è¦æ‰§è¡Œä¸€äº›é¢å¤–çš„æ“ä½œã€‚<br>
åœ¨ csproj æ–‡ä»¶ä¸­å¢åŠ  <code>&lt;GenerateDocumentationFile&gt;true&lt;/GenerateDocumentationFile&gt;</code>ï¼Œå¦å¤–ï¼Œæœ€å¥½åœ¨ <code>/Project/PropertyGroup/NoWarn</code> ä¸­å¢åŠ  1591ï¼Œå¦åˆ™ä½ ä¼šå¾—åˆ°ä¸€å¤§å †çš„ warning : <strong># CS1591: Missing XML comment for publicly visible type or member</strong>. åŸå› æ˜¯é¡¹ç›®ä¸­<strong>å­˜åœ¨æ²¡æœ‰æ³¨é‡Šçš„æ–¹æ³•ï¼Œå±æ€§æˆ–ç±»</strong>ã€‚</p>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/02-vs-swagger.jpg" alt="vs-swagger"></p>
<p>æ³¨ï¼šç”¨ swaggerUI æ¥æµ‹è¯•çš„è¯ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å¦‚æœç”¨ nginx è½¬å‘çš„è¯ï¼Œä¼šéœ€è¦ è·¨åŸŸ CORS çš„æ”¯æŒï¼›</li>
<li>å®é™…ä½¿ç”¨æœ¬åœ°ç½‘ç»œå‘é€è¿‡å»çš„ï¼Œæ¯”å¦‚ï¼Œåœ¨ 10.40.50.237 ä¸Šé¢æ­å»ºçš„ webapiï¼Œè€Œ swaggerUI å‘é€åœ°å€ <code>http://localhost:5000/api/xxx</code>ã€‚</li>
</ol>
<h3 id="ä¸Šä¼ æ–‡ä»¶">ä¸Šä¼ æ–‡ä»¶</h3>
<p>è¿™é‡Œçš„æ–¹æ³•åªé€‚åˆå°æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦å¤§æ–‡ä»¶ä¸Šä¼ ï¼Œéœ€è¦ç”¨åˆ° steam ï¼Œå¤šæ–‡ä»¶ä¸Šä¼ å‚æ•°æ”¹ä¸º <code>List&lt;IFormFile&gt;</code> å³å¯ã€‚ <code>DisableRequestSizeLimit</code> å–æ¶ˆä¸Šä¼ é™åˆ¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="na">[HttpPost, DisableRequestSizeLimit]</span>
<span class="k">public</span> <span class="kt">bool</span> <span class="n">SendStream</span><span class="p">(</span><span class="n">IFormFile</span> <span class="n">_file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">_newFileName</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="n">Combine</span><span class="p">(</span><span class="n">UploadFileManagementBLL</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">StoragePath</span><span class="p">,</span> <span class="n">_file</span><span class="p">.</span><span class="n">FileName</span><span class="p">);</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">_newFileName</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">_file</span><span class="p">.</span><span class="n">CopyTo</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
        <span class="n">fs</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="å…¨å±€å¼‚å¸¸æ•è·">å…¨å±€å¼‚å¸¸æ•è·</h3>
<p>ç”¨åˆ°è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼Œè€Œ asp.net core æä¾›çš„ <code>UseExceptionHandler</code> <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/error-handling?view=aspnetcore-3.1#exception-handler-page">ã€ŠHandle errors in ASP.NET Coreã€‹</a> æˆ‘è§‰å¾—ä¸å¤ªå¥½ç”¨ã€‚<br>
æ—¥å¿—å”¯ä¸€IDï¼š <code>TraceIdentifier</code>ï¼Œæ–¹ä¾¿æ—¥åè·Ÿè¸ªæ—¥å¿—ï¼› <code>UseCustomExceptionMiddleware</code> åœ¨ startup.cs ä¸­ä¸€å®šè¦æ”¾åœ¨ç¬¬ä¸€ä½ï¼Œä¸­é—´ä»¶çš„é¡ºåºæ˜¯æœ‰éå¸¸é‡è¦çš„å½±å“çš„ <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/middleware/?view=aspnetcore-3.1#middleware-order">ã€Šä¸­é—´ä»¶é¡ºåºã€‹</a>ã€‚</p>
<p><img src="/images/2020/20200814-wcf-to-aspnetcore-webapi/03-middleware-pipeline.svg" alt="å®˜æ–¹çš„å›¾ç‰‡"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomExceptionMiddleware</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestDelegate</span> <span class="n">_next</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">CustomExceptionMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span> <span class="n">next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Invoke</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Task</span> <span class="n">HandleExceptionAsync</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Common</span><span class="p">.</span><span class="n">WebApiLogger</span><span class="p">.</span><span class="n">Singleton</span><span class="p">.</span><span class="n">LogMaker</span><span class="p">.</span><span class="n">LogInfo</span><span class="p">(</span><span class="s">$&#34;Unhandled exception UID:[{context.TraceIdentifier}] Message:[{ex}]&#34;</span><span class="p">);</span>

        <span class="kt">string</span> <span class="n">_retString</span> <span class="p">=</span> <span class="s">$&#34;Error! Please contact the administrator.ErrorId:[{context.TraceIdentifier}] Exception:[{ex.Message}].&#34;</span><span class="p">;</span>
        <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">InternalServerError</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">WriteAsync</span><span class="p">(</span><span class="n">_retString</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CustomExceptionMiddlewareExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IApplicationBuilder</span> <span class="n">UseCustomExceptionMiddleware</span><span class="p">(</span><span class="k">this</span> <span class="n">IApplicationBuilder</span> <span class="n">builder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="n">UseMiddleware</span><span class="p">&lt;</span><span class="n">CustomExceptionMiddleware</span><span class="p">&gt;();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="å®¢æˆ·ç«¯-webapiclient">å®¢æˆ·ç«¯ WebApiClient</h2>
<p>åœ¨ç½‘ä¸Šå¯»æ‰¾æœ‰æ²¡æœ‰ç°æˆçš„ RESTful çš„ C# å·¥å…·ï¼Œå‘ç°äº†<a href="https://github.com/dotnetcore/WebApiClient">WebApiClient</a>ï¼Œçœ‹äº†ä¸€ä¸‹æ ·ä¾‹ï¼Œç¡®å®éå¸¸ç®€å•ï¼Œéå¸¸çœäº‹å„¿ï¼Œåªéœ€è¦å†™ä¸ªç®€å•çš„ Interface æ¥å£ç±»ï¼Œå°±å¯ä»¥äº†ï¼Œå…³é”®æ˜¯å®ƒè¿˜<strong>æ”¯æŒå„ç§å¥‡å¥‡æ€ªæ€ªçš„ HTTP æ¥å£</strong>ã€‚<br>
PS: æœ€å¼€å§‹è¯» README.md æ—¶å€™ï¼Œæ€»æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œä¸€ç›´æŠŠå®ƒå½“æˆ server ç«¯çš„å·¥å…·ğŸ˜“ã€‚ç›´åˆ°å¼€å§‹å†™å®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œæ‰çœŸæ­£çœ‹æ‡‚äº†ä»–çš„æ–‡æ¡£ã€‚</p>
<h3 id="webapiclienttool">WebApiClient.Tool</h3>
<p><strong>Swagger æ˜¯ä¸€ä¸ªä¸è¯­è¨€æ— å…³çš„è§„èŒƒï¼Œç”¨äºæè¿° REST API</strong>ã€‚æ—¢ç„¶ Swagger æ˜¯ä¸€ç§è§„èŒƒï¼Œé‚£ä¹ˆææœ‰å¯èƒ½å­˜åœ¨ï¼Œæ ¹æ® <code>Swagger.json</code> ç”Ÿæˆä»£ç çš„å·¥å…·ã€‚æƒ³ç€ WebApiClient å¼€å‘è€…æ˜¯ä¸æ˜¯ä¹Ÿå·²ç»æä¾›äº†å·¥å…·ï¼Œæœç„¶ä¸å‡ºæ‰€æ–™ï¼Œ<a href="https://github.com/xljiulang/WebApiClient.Tools">WebApiClient.Tools</a></p>
<p>åªéœ€è¿è¡Œä¸€è¡Œå‘½ä»¤ï¼Œå°±å¯ä»¥æ ¹æ® <code>Swagger.json</code> ç›´æ¥ç”Ÿæˆå®¢æˆ·ç«¯çš„å®ä½“ç±»ï¼Œæ¥å£ï¼Œç”šè‡³åŒ…æ‹¬æ³¨é‡Šï¼Œç®€ç›´çˆ½çš„ä¸è¦ä¸è¦çš„ï¼Œ<strong>å®Œç¾çš„é¿å¼€äº†æ‰‹å†™ä»£ç çš„è¿‡ç¨‹</strong>ã€‚<br>
æˆ‘çš„å‘½ä»¤ï¼š <code>WebApiClient.Tools.Swagger.exe --swagger=http://10.50.40.237:5000/swagger/v1/swagger.json --namespace=MyWebApiProxy</code></p>
<h3 id="webapiclientjit">WebApiClient.JIT</h3>
<p>ç”±äºè¿˜æœ‰ä¸€å¤§éƒ¨åˆ†çš„ win7 æ¡Œé¢è½¯ä»¶ç”¨æˆ·ï¼Œè€Œä»–ä»¬å¤§æ¦‚ç‡ä¸ä¼šå®‰è£… net core ï¼Œæ‰€ä»¥åªèƒ½é€‰æ‹© net framework çš„ç‰ˆæœ¬ <a href="https://github.com/dotnetcore/WebApiClient/tree/WebApiClient.JITAOT">WebApiClient.JIT</a>ã€‚ä½¿ç”¨èµ·æ¥ä¹Ÿç›¸å½“æ–¹ä¾¿ï¼Œåªéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ä¸€ä¸‹webapiåœ°å€ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨å³å¯ã€‚<br>
WebApiClient æä¾›çš„æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ¥å£ï¼Œç”±äºæ—§é¡¹ç›®å‡çº§ï¼Œé¿å…å¤§å¹…æ”¹åŠ¨ï¼Œå°±æ²¡æœ‰ä½¿ç”¨å¼‚æ­¥çš„åŠŸèƒ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">InitialWebApiConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">_baseUrl</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HttpApi</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">IUserManagementApi</span><span class="p">&gt;().</span><span class="n">ConfigureHttpApiConfig</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">c</span><span class="p">.</span><span class="n">HttpHost</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Uri</span><span class="p">(</span><span class="n">_baseUrl</span><span class="p">);</span>
        <span class="n">c</span><span class="p">.</span><span class="n">FormatOptions</span><span class="p">.</span><span class="n">DateTimeFormat</span> <span class="p">=</span> <span class="n">DateTimeFormats</span><span class="p">.</span><span class="n">ISO8601_WithoutMillisecond</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="n">Todo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">HttpApi</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IUserManagementApi</span><span class="p">&gt;())</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">_req</span> <span class="p">=</span> <span class="k">new</span> <span class="n">LoginRequestV2</span><span class="p">();</span>
        <span class="n">_response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="n">UserLoginExAsync</span><span class="p">(</span><span class="n">_req</span><span class="p">).</span><span class="n">InvokeAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="éƒ¨ç½²-ubuntu--nginx">éƒ¨ç½² Ubuntu + Nginx</h2>
<p>é¡¹ç›®çš„æœåŠ¡ç«¯ï¼Œå¯¹æ“ä½œç³»ç»Ÿæ²¡æœ‰ç‰¹åˆ«è¦æ±‚ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©æœ€æ–°çš„ <code>Ubuntu 20.04.1 LTS</code> ã€‚å¸å–äº† gRPC éƒ¨ç½²çš„ä¸€äº›ç»éªŒï¼Œè¿™æ¬¡åªéƒ¨ç½² http æœåŠ¡ï¼Œé¢å¤–å¢åŠ äº† nginx åå‘ä»£ç†ï¼Œåªæ˜¯å› ä¸ºåœ¨å®˜ç½‘ä¸Šçœ‹åˆ°äº†<a href="https://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1">ã€Šä½¿ç”¨ Nginx åœ¨ Linux ä¸Šæ‰˜ç®¡ ASP.NET Coreã€‹</a>ğŸ˜œã€‚</p>
<p>Kestrel æ˜¯ ASP.NET Core é¡¹ç›®æ¨¡æ¿æŒ‡å®šçš„é»˜è®¤ Web æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒASP.NET Coreæ˜¯ä¸éœ€è¦é¢å¤–çš„å®¹å™¨çš„ã€‚<a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/?view=aspnetcore-3.1&amp;tabs=windows#kestrel">ã€ŠASP.NET Core ä¸­çš„ Web æœåŠ¡å™¨å®ç°ã€‹</a>ã€‚ä¸‹é¢æ˜¯æˆ‘çš„å…·ä½“å®ç°æ“ä½œï¼š</p>
<ol>
<li>
<p>æ ¹æ®æ–‡æ¡£<a href="https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-ubuntu#2004-">ã€Šåœ¨ Linux ä¸Šå®‰è£… .NET Coreã€‹</a> å’Œ <a href="https://docs.microsoft.com/zh-cn/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-3.1#install-nginx">ã€Šå®‰è£… Nginxã€‹</a> æŒ‡å¼•ï¼Œå®‰è£… <code>aspnetcore-runtime-3.1</code> å’Œ <code>nginx</code>ï¼›</p>
</li>
<li>
<p>é…ç½® Nginx ï¼Œè¿™éƒ¨åˆ†æˆ‘ç”¨çš„æ¯”è¾ƒç®€å•ï¼Œåªç”¨åˆ°è½¬å‘åŠŸèƒ½ï¼Œæœªæ¥å¯èƒ½åœ¨è¿™ä¸€å±‚<strong>å¢åŠ  SSL</strong> ï¼›å¦å¤– <code>try_files $uri $uri/ =404</code> è¿™ä¸€å¥éœ€è¦æ³¨é‡Šæ‰æ‰è¡Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; sudo nano /etc/nginx/sites-available/default

server <span class="o">{</span>
    listen <span class="m">80</span> default_server<span class="p">;</span>
    listen <span class="o">[</span>::<span class="o">]</span>:80 default_server<span class="p">;</span>

    root /var/www/html<span class="p">;</span>
    index index.html index.htm index.nginx-debian.html<span class="p">;</span>
    server_name _<span class="p">;</span>
    location / <span class="o">{</span>
            <span class="c1"># First attempt to serve request as file, then</span>
            <span class="c1"># as directory, then fall back to displaying a 404.</span>
            <span class="c1"># try_files $uri $uri/ =404;</span>
            proxy_pass http://localhost:5000<span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>

&gt; sudo nginx -t    <span class="c1"># éªŒè¯é…ç½®æ–‡ä»¶çš„è¯­æ³•</span>
&gt; sudo nginx -s reload
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>åˆ›å»º Linux çš„ web api çš„æœåŠ¡æ–‡ä»¶ï¼Œå¹¶å¯åŠ¨ã€‚æˆ‘çš„ç¤ºä¾‹ï¼Œ<code>--urls</code>è¿™ä¸ªæ˜¯éå¸¸å®ç”¨çš„å‚æ•°ï¼Œå¯å¤šç«¯å£ï¼›<strong>é‡ç‚¹æ³¨æ„</strong> <code>ASPNETCORE_ENVIRONMENT</code> åœ¨é…ç½®<strong>æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œè¿˜æ˜¯å¼€å‘ç¯å¢ƒ</strong>ï¼›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; sudo nano /etc/systemd/system/kestrel-mywebapi.service

<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>mywebapi App running on Ubuntu

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">WorkingDirectory</span><span class="o">=</span>/home/user/publish
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dotnet /home/user/publish/MyWebApi.dll --urls http://localhost:5000
<span class="nv">Restart</span><span class="o">=</span>always
<span class="c1"># Restart service after 10 seconds if the dotnet service crashes:</span>
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">10</span>
<span class="nv">KillSignal</span><span class="o">=</span>SIGINT
<span class="nv">SyslogIdentifier</span><span class="o">=</span>dotnet-example
<span class="nv">User</span><span class="o">=</span>user
<span class="c1"># Production Development</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">ASPNETCORE_ENVIRONMENT</span><span class="o">=</span>Development
<span class="nv">Environment</span><span class="o">=</span><span class="nv">DOTNET_PRINT_TELEMETRY_MESSAGE</span><span class="o">=</span><span class="nb">false</span>

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

&gt; sudo systemctl <span class="nb">enable</span> kestrel-mywebapi.service
&gt; sudo systemctl restart kestrel-mywebapi.service
&gt; sudo systemctl status kestrel-mywebapi.service
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>å¼€å¯é˜²ç«å¢™ç«¯å£ï¼ŒUbuntu æ˜¯<strong>é»˜è®¤å…³é—­22ç«¯å£</strong>ã€‚å®‰å…¨èµ·è§ï¼Œé¿å…è¢«é¢‘ç¹æ‰«æï¼Œå»ºè®®æŠŠ ssh é»˜è®¤ç«¯å£ 22 æ”¹ä¸ºå…¶ä»–ä¸å¸¸è§çš„ç«¯å£å·ã€‚</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo netstat -aptn
sudo apt-get install ufw
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp

sudo ufw <span class="nb">enable</span>
sudo ufw status
</code></pre></td></tr></table>
</div>
</div><p>æµè§ˆå™¨æµ‹è¯• <code>http://10.50.40.237</code>ï¼Œè¿”å›é¢„æœŸçš„<code>Hello Asp.Net Core WebApi 3.1!</code>ï¼Œå®Œç¾ğŸ˜ã€‚è¿˜æœ‰ä¸€ä¸ªå°å‘å°±æ˜¯ https è¿˜æ²¡æœ‰é…ç½®ã€‚</p>
<h3 id="è‡ªåŠ¨åŒ–è„šæœ¬">è‡ªåŠ¨åŒ–è„šæœ¬</h3>
<p>åœ¨å¼€å‘é˜¶æ®µï¼Œéœ€è¦<strong>ç»å¸¸å¾—ç¼–è¯‘ï¼Œæ‰“åŒ…ï¼Œä¸Šä¼ </strong>ã€‚è™½ç„¶ VS2019 å…·æœ‰ç›´æ¥å‘å¸ƒåˆ° FTP çš„åŠŸèƒ½ï¼Œä¸è¿‡æˆ‘æ²¡æœ‰ä½¿ç”¨ã€‚ä¸€æ–¹é¢ï¼Œè¯¥åŠŸèƒ½ä»æ¥æ²¡ç”¨è¿‡ï¼Œå¦ä¸€æ–¹é¢ï¼Œè¿˜æ˜¯æƒ³è‡ªå·±å†™ä¸ªæ›´åŠ çµæ´»çš„è„šæœ¬ã€‚<br>
ç›®å‰åªå®ç°äº† ç¼–è¯‘ï¼Œæ‰“åŒ…ï¼Œä¸Šä¼ çš„åŠŸèƒ½ï¼Œåç»­å†å¢åŠ  ssh ç™»å½•ï¼Œè§£å‹ï¼Œé‡å¯ asp.net ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bat" data-lang="bat"><span class="k">echo</span> only win10

<span class="k">cd</span> D:\Projects\lst\01-MyWebApi\MyWebApi
<span class="c1">rem å·²æ³¨é‡Šï¼šdotnet publish --output bin/publish/ --configuration Release --runtime linux-x64 --framework netcoreapp3.1 --self-contained false</span>
dotnet publish -p:PublishProfileFullPath=/Properties/PublishProfiles/FolderProfile.pubxml --output bin/publish/

<span class="k">cd</span> bin
tar.exe -a -c -f publish.zip publish

<span class="s2">&#34;C:\Program Files\PuTTY\psftp.exe&#34;</span>

open 10.50.40.237
Welcome123
put <span class="s2">&#34;D:\Projects\lst\01-LstWebApi\LenovoSmartToolWebApi\bin\publish.zip&#34;</span>
<span class="k">exit</span>

<span class="c1">rem å·²æ³¨é‡Šï¼š&#34;C:\Program Files\PuTTY\putty.exe&#34; user@10.40.50.237 22 -pw password</span>

<span class="k">pause</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦å¤–ï¼Œç”¨ä¸€ä¸ª WinForm çš„æµ‹è¯•å°ç¨‹åºï¼Œå°è¯•äº† <code>self-contained = true</code> è¿™ç§å‘å¸ƒæ–¹å¼ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯å®‰è£… net core å°±èƒ½è¿è¡Œï¼Œå‘ç°ç¼–è¯‘åä» 1M+ å¤§å¹…å¢åŠ åˆ° 150M+ ï¼Œå¦¥å¦¥çš„å“åäº†ã€‚å³ä½¿ä½¿ç”¨äº† <code>PublishTrimmed=true</code> <a href="https://docs.microsoft.com/zh-cn/dotnet/core/deploying/trim-self-contained">ã€Šå‰ªè£ç‹¬ç«‹éƒ¨ç½²å’Œå¯æ‰§è¡Œæ–‡ä»¶ã€‹</a>ï¼Œå¤§å°ä¹Ÿæœ‰ 100M+ï¼Œæœæ–­æ”¾å¼ƒã€‚</p>
<h2 id="å…¶ä»–çš„æ”¹åŠ¨">å…¶ä»–çš„æ”¹åŠ¨</h2>
<h3 id="log4net">log4net</h3>
<p>log4net ç”± <code>1.2.13.0</code> å‡çº§åˆ° <code>2.0.8</code>åï¼Œåˆå§‹åŒ–é…ç½®æ–‡ä»¶æ–¹æ³•æ–°å¢ä¸€ä¸ªå‚æ•°<code>ILoggerRepository</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">InitLog4NetConfig</span><span class="p">(</span><span class="kt">string</span> <span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">_rep</span> <span class="p">=</span> <span class="n">LogManager</span><span class="p">.</span><span class="n">GetRepository</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">Assembly</span><span class="p">.</span><span class="n">GetCallingAssembly</span><span class="p">());</span>
    <span class="n">log4net</span><span class="p">.</span><span class="n">Config</span><span class="p">.</span><span class="n">XmlConfigurator</span><span class="p">.</span><span class="n">Configure</span><span class="p">(</span><span class="n">_rep</span><span class="p">,</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">IO</span><span class="p">.</span><span class="n">FileInfo</span><span class="p">(</span><span class="n">file</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>éƒ¨ç½²åˆ° Ubuntu åï¼Œå‘ç° log4net æŠ¥é”™ã€‚éœ€è¦æŠŠ <code>log4net.Appender.ColoredConsoleAppender</code> æ›¿æ¢ä¸º <code>log4net.Appender.ManagedColoredConsoleAppender</code>ã€‚æ˜¯ç”±äº<strong>ä¸åŒçš„ Appender æ”¯æŒçš„ Framework ä¸åŒ</strong>ï¼Œ ColoredConsoleAppender æ”¯æŒ NET Framework 1.0~4.0 ï¼Œ ManagedColoredConsoleAppender æ”¯æŒ NET Framework 2.0+ ã€‚è¯¦è§ï¼š<a href="https://logging.apache.org/log4net/release/framework-support.html">ã€ŠApache log4netâ„¢ Supported Frameworksã€‹</a></p>
<h3 id="framework-40-çš„-md5-æ–¹æ³•åºŸå¼ƒ">Framework 4.0 çš„ md5 æ–¹æ³•åºŸå¼ƒ</h3>
<p>MD5 æ‘˜è¦ä¹Ÿå‡ºç°é—®é¢˜ï¼Œéœ€è¦æ›´æ”¹ã€‚åŸå› æ˜¯ HashPasswordForStoringInConfigFile åœ¨ net core ä¸­å·²ç»ä¸å¯ç”¨äº†ï¼Œè¯¥æ–¹æ³•åœ¨ framework 4.5 ä¸­ä¹Ÿæç¤ºä¸ºåºŸå¼ƒçš„æ–¹æ³•ã€‚ä¿®æ”¹ä¸ºä¸‹é¢æ–°çš„ MD5 æ–¹æ³•å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">GetOldMD5</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">FormsAuthentication</span><span class="p">.</span><span class="n">HashPasswordForStoringInConfigFile</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&#34;MD5&#34;</span><span class="p">).</span><span class="n">ToLower</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">GetNewMD5</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">MD5</span> <span class="n">md5</span> <span class="p">=</span> <span class="n">MD5</span><span class="p">.</span><span class="n">Create</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">retVal</span> <span class="p">=</span> <span class="n">md5</span><span class="p">.</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
        <span class="n">StringBuilder</span> <span class="n">_sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">retVal</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="n">_sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">retVal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ToString</span><span class="p">(</span><span class="s">&#34;x2&#34;</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">_sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="datetimeoffset-å’Œ-datetime">DateTimeOffset å’Œ DateTime</h3>
<p>ä»¥å‰ä»æ¥æ²¡æœ‰è€ƒè™‘è¿‡ UTC æ—¶é—´ï¼Œè¿™æ¬¡æ·±æ·±çš„ä¸Šäº†ä¸€è¯¾ï¼Œ WebApi ä¸­æ‰€æœ‰ä¼ é€’çš„æ—¶é—´å…¨éƒ¨æ˜¯ UTC æ—¶é—´ã€‚ <code>DateTime.MinValue</code> è½¬åŒ–ä¸º UTC æ—¶é—´åï¼Œå¯èƒ½ä¼šå‡ºç°å°äº <code>0001\01\01 00:00:00</code>çš„æ—¶é—´ã€‚éœ€è¦é¢å¤–å¤„ç†ä¸€ä¸‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">RequestPartialContent</span><span class="p">(</span><span class="kt">long</span> <span class="n">_userId</span><span class="p">,</span> <span class="n">DateTime</span> <span class="n">_newDataTime</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Uid</span> <span class="p">=</span> <span class="n">_userId</span><span class="p">;</span>

    <span class="c1">// è½¬åŒ–ä¸º utc æ—¶é—´åï¼Œå¯èƒ½ä¼šå°äº MinValue
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_newDataTime</span><span class="p">.</span><span class="n">ToUniversalTime</span><span class="p">()</span> <span class="p">&lt;=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">MinValue</span><span class="p">.</span><span class="n">UtcDateTime</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">StartDateVersion</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">MinValue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">StartDateVersion</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DateTimeOffset</span><span class="p">(</span><span class="n">_newDataTime</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>ç›®å‰ï¼Œåªè¿ç§»äº†ä¸€éƒ¨åˆ†çš„ WCF æ¥å£è¿‡æ¥ï¼Œç­‰å¾…éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¯ä»¥ç¨³å®šè¿è¡Œåï¼Œå†å°†å‰©ä½™éƒ¨åˆ†å…¨éƒ¨è¿ç§»è¿‡æ¥ã€‚è¿™æ¬¡çš„å°è¯•æ¯”è¾ƒæˆåŠŸï¼š</p>
<ol>
<li>ä¸€æ˜¯æ»¡è¶³äº†åŸºæœ¬éœ€æ±‚ï¼Œ<strong>è¾ƒå°‘æ”¹åŠ¨è€æ—§ä»£ç </strong>ï¼›</li>
<li>äºŒæ˜¯å¤§éƒ¨åˆ†<strong>ä»£ç ç”±å·¥å…·ç”Ÿæˆ</strong>ï¼Œæ¯”å¦‚ API æ–‡æ¡£ï¼Œæ¥å£çš„å®ä½“ç±»ï¼›</li>
<li>ä¸‰æ˜¯å¾ˆå¤šå¸¸ç”¨åŠŸèƒ½ï¼Œéƒ½æœ‰<strong>ç°æˆçš„æ’ä»¶æ¥</strong>å®Œæˆã€‚</li>
</ol>
<p>æˆ‘åªéœ€è¦ä¿®æ”¹ç¼–è¾‘å™¨çš„ ERROR çš„æç¤ºå°±å¯ä»¥äº†ã€‚<strong>æ„Ÿè§‰æ²¡æœ‰å†™ä»€ä¹ˆä»£ç </strong>ğŸ¤£ã€‚ã€‚ã€‚é¡¶å¤šåªå†™äº†å‡ è¡Œ<strong>ç²˜åˆä»£ç </strong>ğŸ¤£ï¼Œä¸€ç§æ­ç§¯æœ¨çš„æ„Ÿè§‰ğŸ˜ã€‚å…¶ä¸­ asp.net web api è¿˜æœ‰å¾ˆå¤šçš„åŠŸèƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œè¿˜éœ€è¦æ›´åŠ ç»†åŒ–åˆ°é¡¹ç›®ä¸­ã€‚è·¯æ¼«æ¼«~~</p>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Long</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
      2020-08-14 23:46
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content">åŸåˆ›æ–‡ç« ï¼Œå¦‚éœ€è½¬è½½è¯·æ³¨æ˜æ–‡ç« ä½œè€…å’Œå‡ºå¤„ã€‚<br/><a rel="license noopener" href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank">ç½²å 4.0 å›½é™… (CC BY 4.0)</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://mrbenwang.github.io/tags/net-core/">net core</a>
          <a href="https://mrbenwang.github.io/tags/web-api/">web api</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/2020/20200813-wcf-to-aspnetcore-grpc/">
            <span class="next-text nav-default">*æ—§ WCF é¡¹ç›®è¿ç§»åˆ° asp.net core &#43; gRPC çš„å°è¯•</span>
            <span class="prev-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "MrBenWang/comments-for-my-blog"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:wzlblair@foxmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://www.facebook.com/laowang.atlas/" rel="me noopener" class="iconfont"
      title="facebook"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="33" height="33">
  <path d="M965.7344 2.7648c14.848 0 28.2624 5.5296 40.2432 16.6912C1017.9584 30.5152 1024 43.52 1024 58.2656l0 910.2336c0 14.848-6.0416 27.7504-18.0224 38.8096C993.8944 1018.4704 980.48 1024 965.7344 1024L704.9216 1024 704.9216 629.9648l133.2224 0 19.456-155.4432-152.576 0L705.024 373.0432c0-50.688 25.9072-76.0832 77.7216-76.0832l80.4864 0L863.232 163.5328c-27.7504-5.4272-67.4816-8.192-119.296-8.192-59.1872 0-106.8032 18.0224-142.9504 54.0672C564.736 245.5552 546.7136 296.0384 546.7136 360.7552l0 113.7664L413.4912 474.5216l0 155.4432 133.2224 0L546.7136 1024 55.5008 1024c-14.848 0-27.7504-5.5296-38.8096-16.6912C5.5296 996.2496 0 983.3472 0 968.4992L0 58.2656C0 43.52 5.5296 30.5152 16.6912 19.456c11.0592-11.0592 24.064-16.6912 38.8096-16.6912L965.7344 2.7648z"></path>
</svg>

    </a>
  
    <a href="https://github.com/MrBenWang" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/wzlblair" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/344871908" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="https://mrbenwang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2007 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Long
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  











  <script>
    $("#openSearch, #openSearchMobile").click(function(){
      $(".modal-dialog").addClass("visible");
    });

    $("#closeSearch").click(function(){
      $(".modal-dialog").removeClass("visible");
    });

    $(document).click(function(event) {
    
      if (!$(event.target).closest(".modal-content, #openSearch, #openSearchMobile").length) {
        $("body").find(".modal-dialog").removeClass("visible");
      }
    });
  </script>




  <script src="/js/custom.js"></script>


</body>
</html>
